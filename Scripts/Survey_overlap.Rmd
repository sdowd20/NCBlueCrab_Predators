---
title: "NCDMF overlap_exploration"
author: "Sally Dowd"
date: "06/05/23"
output: html_document
---

This code was adopted and modified from Sarah Roberts ([sroberts\@nyelab.org](mailto:sroberts@nyelab.org){.email}) who created it in 01/2022.

#### Load packages and datasets

```{r}
packages <- c("ggplot2", "tidyverse", "lubridate", "sf", "sp", "dplyr", "rnaturalearth", "readr", "readxl", "spatialEco", "gt")

invisible(lapply(packages, library, character.only= TRUE))

standard_theme <- theme_bw() + theme(panel.border = element_rect(fill=NA, colour = "black")) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.text.align= 0, legend.title= element_text(size = 12), legend.text = element_text(size= 10), axis.text=element_text(size=10), axis.title=element_text(size=12))

world <- ne_countries(scale = "medium", returnclass = "sf")

#p120 <- read.csv("p120_biol_new.csv")
setwd("~/Documents/GitHub/NCBlueCrab_Predators")
p120 <- read.csv("Data/P120/Finalized/p120_CPUE.csv")
p915 <- read.csv("Data/P915/Finalized/p915_CPUE.csv")
p195 <- read.csv("Data/P195/Finalized/p195_abund.csv")
p195$Season <- ifelse(p195$Month==4 | p195$Month==5 | p195$Month==6, "Spring", ifelse(p195$Month==9 |p195$Month==10 | p195$Month==11 | p195$Month==12, "Fall", ifelse(p195$Month==7 |p195$Month==8, "Summer", "Winter")))
#p195 <- read.csv("Data/P195/Finalized/p195_clean_new.csv") #changed to new p120 and p195 dataset on 07/10/23

colnames(p915)
min(p120$Depth)
min(p915$Depth)
min(p195$Depth)

colnames(p195)
unique(p120$Location)
p195 %>% select(Depthend)
unique(p195$Location)

#Select columns from datasets
p915_overlap <- p915 %>% dplyr::select(Date, Year, Month, Area, Ssal, Stemp, Sdo, Speciescommonname, Colnum, Latitude, Longitude, Sciname, Season) %>% mutate(Survey= "P915", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)
p120_overlap <- p120 %>% dplyr::select(Date, Year, Month, Station, Stemp, Ssal, Sdo, Speciescommonname, Colnum, Lat_dd, Long_dd, Sciname, Season) %>% dplyr::rename("Area" = "Station", "Latitude"= "Lat_dd", "Longitude" = "Long_dd") %>% mutate(Survey= "P120", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)
p195_overlap <- p195 %>% dplyr::select(Date, Year, Month, Location, Tempsurface, Salinitysurface, Sdo, Speciescommonname, Numbertotal, Latitudestart, Longitudestart, Sciname, Season) %>% dplyr::rename("Area"= "Location", "Stemp"= "Tempsurface", "Ssal"= "Salinitysurface", "Latitude"= "Latitudestart", "Longitude"= "Longitudestart", "Colnum"= "Numbertotal") %>% mutate(Survey= "P195", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)

colnames(p915_overlap)
colnames(p120_overlap)
colnames(p195_overlap)

#Load in world datasest and form grid
world <- ne_countries(scale = "medium", returnclass = "sf")
# make an object the size and shape of the output you want
globe_bb <- matrix(c(-78.900147,33.802938,
                      -78.900147,36.672128,
                      -75.263672,36.672128,
                     -75.263672, 33.802938,
                     -78.900147,33.802938), byrow = TRUE, ncol = 2) %>% list() %>% st_polygon() %>% st_sfc(., crs = 4326)

globe_grid_20 <- st_make_grid(x= globe_bb, n = c(20,20), crs = 4326, what = 'polygons') %>% st_sf('geometry' = ., data.frame('ID' = 1:length(.)))
```

#### Load functions for graphs

```{r}
sp_over_pos_pos <- function(species){
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = subset(p195, p195$Speciescommonname %in% "blue crab" & as.numeric(p195$Numbertotal > 0)), aes(x = as.numeric(Longitudestart), y = as.numeric(Latitudestart), size= Numbertotal), colour= "orange") + geom_point(data = subset(p120, p120$Speciescommonname %in% "blue crab" & as.numeric(p120$Colnum > 0)), aes(x = as.numeric(Long_dd), y = as.numeric(Lat_dd), size= Colnum), colour= "pink") + geom_point(data = subset(p915, p915$Speciescommonname %in% species & as.numeric(p915$Colnum > 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), size= Colnum), colour= "blue") + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude") + guides(size= F, scale= "none") + facet_wrap(~Season)
}

sp_over_pos_zero <- function(species){
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = subset(p195, p195$Speciescommonname %in% "blue crab" & as.numeric(p195$Numbertotal > 0)), aes(x = as.numeric(Longitudestart), y = as.numeric(Latitudestart), size= Numbertotal), colour= "orange") + geom_point(data = subset(p120, p120$Speciescommonname %in% "blue crab" & as.numeric(p120$Colnum > 0)), aes(x = as.numeric(Long_dd), y = as.numeric(Lat_dd), size= Colnum), colour= "pink") + geom_point(data = subset(p915, p915$Speciescommonname %in% species & as.numeric(p915$Colnum == 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), size= Colnum), colour= "blue") + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude") + guides(size= F, scale= "none") + facet_wrap(~Season)
}

sp_over_zero_pos <- function(species){
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = subset(p195, p195$Speciescommonname %in% "blue crab" & as.numeric(p195$Numbertotal == 0)), aes(x = as.numeric(Longitudestart), y = as.numeric(Latitudestart), size= Numbertotal), colour= "orange") + geom_point(data = subset(p120, p120$Speciescommonname %in% "blue crab" & as.numeric(p120$Colnum == 0)), aes(x = as.numeric(Long_dd), y = as.numeric(Lat_dd), size= Colnum), colour= "red") + geom_point(data = subset(p915, p915$Speciescommonname %in% species & as.numeric(p915$Colnum > 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), size= Colnum), colour= "blue") + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude")+ guides(size= F, scale= "none") + facet_wrap(~Season)
}

t <- p195 %>% filter(Speciescommonname %in% "blue crab") 

unique(t$Numbertotal)
sp_over_zero_zero <- function(species){
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = subset(p120, p120$Speciescommonname %in% "blue crab" & as.numeric(p120$Colnum > 0)), aes(x = as.numeric(Long_dd), y = as.numeric(Lat_dd), size= Colnum), colour= "red") + geom_point(data = subset(p915, p915$Speciescommonname %in% species & as.numeric(p915$Colnum == 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), size= Colnum), colour= "blue") + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude")+ guides(size= F, scale= "none") + facet_wrap(~Season)
}
```

#### Where focal species are caught

```{r}
#P915
p915 %>% group_by(Speciescommonname) %>% summarize(n= sum(as.numeric(Colnum)))

coords_captured <- function(species){
ggplot(data = world) + geom_sf() + geom_point(data = subset(p915, p915$Speciescommonname %in% species & as.numeric(p915$Colnum > 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), colour = Colnum)) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude", colour= "# caught") + ggtitle(species)
}

coords_captured("bonnethead hammerhead")
coords_captured("blue crab") 
coords_captured("blue catfish") 
coords_captured("red drum") 
coords_captured("southern kingfish") 
coords_captured("southern flounder") 
coords_captured("striped bass")

#P120
p120_edt %>% group_by(Speciescommonname) %>% drop_na(Colnum) %>% summarize(n= sum(as.numeric(Colnum)))

coords_captured_p120 <- function(species){
ggplot(data = world) + geom_sf() + geom_point(data = subset(p120_edt, p120_edt$Speciescommonname %in% species), aes(x = as.numeric(Long_dd), y = as.numeric(Lat_dd), colour = Colnum)) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude", colour= "# caught") + ggtitle(species)
}

coords_captured_p120("northern brown shrimp")
coords_captured_p120("bluefish")
coords_captured_p120("atlantic croaker")
coords_captured_p120("southern flounder")
coords_captured_p120("red drum")
coords_captured_p120("blue catfish")
coords_captured_p120("gizzard shad")
coords_captured_p120("american shad")
coords_captured_p120("blue crab")
```

#### Bind together all datasets & explore

```{r}
#Bind together
total <- rbind(p915_overlap, p120_overlap, p195_overlap)
total$Date <- as.Date(total$Date, format= "%Y-%m-%d")
total$Ym_date <- format(total$Date, "%Y-%m")
total$Season <- ifelse(total$Month==4 | total$Month==5 | total$Month==6, "Spring", ifelse(total$Month==9 |total$Month==10 | total$Month==11 | total$Month==12, "Fall", ifelse(total$Month==7 |total$Month==8, "Summer", "Winter")))

#Explore 
total %>% group_by(Date, Survey, Latitude, Longitude) %>% summarize(abundance= mean(Colnum)) %>% ggplot() + geom_point(aes(x= Date, y= abundance, colour= Survey)) + standard_theme

ggplot() + geom_histogram(data = total, stat="count", aes(x=Ym_date, fill = Survey)) + standard_theme

#Reduce dataset for gridding 
p915_lat_lon <- p915_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
p120_lat_lon <- p120_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
p195_lat_lon <-p195_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
total_lat_lon <- rbind(p915_lat_lon, p120_lat_lon, p195_lat_lon)
```

#### Form a grid individually over datasets

```{r}
ggplot(data = world) + geom_sf() + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total, aes(x = Longitude, y = Latitude, colour = Survey), size = .2) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE)

fish_spat <- as.data.frame(total_lat_lon)
fish_spat$rowID <- 1:nrow(fish_spat)

coordinates(fish_spat) <- ~ Longitude + Latitude
fish_spat <- st_as_sf(fish_spat)
fish_spat <- st_set_crs(fish_spat, 4326)
grid <- globe_grid_20

fish_extract <- st_intersection(fish_spat, grid)
fish_extract_2 <- as.data.frame(fish_extract)

#Group to get rid of duplicates (there are times when a point is overlapping two grid cells)
fish_extract_2_2 <- fish_extract_2[!duplicated(fish_extract_2[c("rowID")]),] #this should be the same size as fish spat, it is 5 observations less, thinking this is bc a few datapoints might be outside of grid cells, didn't change in size from fish_extract_2
fish_extract_2_2$gridID <- fish_extract_2_2$ID
fish_extract_2_2edt <- fish_extract_2_2[,-c(2,3, 4)]
#write.csv(fish_extract_2_2edt, "~/Documents/GitHub/NCBlueCrab_Predators/Data/fish_extract_2_2.csv") #updated on 07/11/23
```

#### Edit gridded dataset

```{r}
fish_extract_2_2_real <- read.csv("~/Documents/GitHub/NCBlueCrab_Predators/Data/fish_extract_2_2.csv") #note that columns are getting messed up here, we just need lat_lon so it doesn't matter for us 
total_edt <- total %>% left_join(fish_extract_2_2_real, by= "lat_lon")
#Check data: 161 data points have NA for grid cells, NA points as out of study area 
summary(is.na(total_edt))
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + coord_sf(xlim=c(-85, -70), ylim=c(25,40), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total_edt %>% filter(gridID %in% NA), aes(x = Longitude, y = Latitude, colour = Survey), size = .2)

#Remove NA for gridID
total_edt <- total_edt %>% drop_na(gridID)
colnames(total_edt)

#write.csv(total_edt, "~/Documents/GitHub/NCBlueCrab_Predators/Data/total_gridded.csv") #updated on 07/11/23
```

#### Overlap

##### Dataframe: spatial and temporal

```{r}
#Load and filter total dataset 
total_edt <- read.csv("~/Documents/GitHub/NCBlueCrab_Predators/Data/total_gridded.csv", header= T) #is survey_overlap added up
total_edt <- total_edt[,-1]
select_spp <- c("atlantic croaker", "blue crab", "black drum", "blue catfish", "bonnethead hammerhead", "brown shrimp", "red drum", "sheepshead", "southern flounder", "southern kingfish", "striped bass", "white shrimp", "pink shrimp", "gizzard shad", "american shad")

total_edt <- total_edt %>% filter(Speciescommonname %in% select_spp, !Area %in% "CAPEF", !Area %in% "NEWR", Year >= 2008, Season %in% "Spring"| Season %in% "Summer", Longitude > -77.0)

p915_overlap_edt <- p915_overlap %>% filter(Speciescommonname %in% select_spp)
p120_overlap_edt <- p120_overlap %>% filter(Speciescommonname %in% select_spp)
p195_overlap_edt <- p195_overlap %>% filter(Speciescommonname %in% select_spp)

total_edt_month <- total_edt %>% dplyr::select(-Season)
total_edt_seas <- total_edt %>% dplyr::select(-Month) 

#Explore grid cell occupancy 
##Number of observations (at least one species present) in each gridID
gridID_count <- total_edt %>% filter(Colnum > 0) %>% group_by(Survey, gridID) %>% summarize(count = n()) 

##Number of unique gridIDs with occupancy data
total_edt %>% filter(Survey %in% "P915", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID))
total_edt %>% filter(Survey %in% "P120", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID))
total_edt %>% filter(Survey %in% "P195", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID)) #number of unique 

##Overlapping grid IDs
###In general:
p915_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P915") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)
p120_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P120") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)
p195_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P195") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)
library(plyr)
match_df(p915_overlap_gridID, p120_overlap_gridID, on = NULL)
match_df(p915_overlap_gridID, p195_overlap_gridID, on = NULL)
match_df(p195_overlap_gridID, p120_overlap_gridID, on = NULL) #results consistent when look at season 

###By season:
p915_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P915") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)
p120_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P120") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)
p195_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P195") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)

match_df(p195_overlap_gridIDs %>% filter(Season %in% "Winter") %>% select(gridID), p120_overlap_gridIDs %>% filter(Season %in% "Winter") %>% select(gridID)) #tested with season and results were very similar 

#Grid, Month: Are there times when fish of the same species were caught at the same time (month, gridID and year) in each of the surveys? 
fish_grid_m <- total_edt_month %>% group_by(Year, Month, Species, Survey, gridID) %>% summarise(unique_fish = n_distinct(Colnum)) %>% pivot_wider(names_from = Survey, values_from = unique_fish) #n_distinct: counts unique combinations, how many times a fish was sampled in a grid cell 

#Grid, Season 
fish_grid_s <- total_edt_seas %>% group_by(Year, Season, Species, Survey, gridID) %>% summarise(unique_fish = n_distinct(Colnum)) %>% pivot_wider(names_from = Survey, values_from = unique_fish)
```

##### Basic spp visualzation

```{r}
#Species-specific 
ss_survey_vis <- function(species){
ggplot() + geom_sf(data = world) + geom_point(data = subset(total_edt, total_edt$Species %in% species & Colnum > 0), aes(x = Longitude, y = Latitude)) + scale_size_area() + facet_wrap(~Survey) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))

}

ss_survey_vis("blue crab")
ss_survey_vis("bonnethead hammerhead")
ss_survey_vis("atlantic croaker")
ss_survey_vis("black drum")
ss_survey_vis("red drum")
ss_survey_vis("blue catfish")
ss_survey_vis("sheepshead")
ss_survey_vis("southern flounder")
ss_survey_vis("southern kingfish")
ss_survey_vis("striped bass")
ss_survey_vis("brown shrimp") #species-name issues are resolved here: species found in trawls are represented here

ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total_edt %>% filter(gridID %in% NA), aes(x = Longitude, y = Latitude, colour = gridID), size = .2) + facet_wrap(~Survey) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))


ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total_edt %>% filter(gridID %in% NA), aes(x = Longitude, y = Latitude, colour = gridID), size = .2) + facet_wrap(~Survey) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))



ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = subset(total_edt, total_edt$Species %in% "blue catfish" & Colnum > 0), aes(x = Longitude, y = Latitude, fill= gridID)) + scale_size_area() + facet_wrap(~Survey) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))

test3 <- match_df[[4]]

```

##### Overlap metrics

```{r}
#Overlapping lats and longs from both datasets 
p915_p120_lat_lon <- p915_overlap_edt %>% filter(Latitude >= min(p120_overlap_edt$Latitude) & Latitude <= max(p120_overlap_edt$Latitude) & Year >= min(p120_overlap_edt$Year) & Year <= max(p120_overlap_edt$Year))

p120_p915_lat_lon <- p120_overlap_edt %>% filter(Latitude >= min(p915_overlap_edt$Latitude) & Latitude <= max(p915_overlap_edt$Latitude) & Year >= min(p915_overlap_edt$Year) & Year <= max(p915_overlap_edt$Year))

p915_p195_lat_lon <- p915_overlap_edt %>% filter(Latitude >= min(p195_overlap_edt$Latitude) & Latitude <= max(p195_overlap_edt$Latitude) & Year >= min(p195_overlap_edt$Year) & Year <= max(p195_overlap_edt$Year))

p195_p120_lat_lon <- p195_overlap_edt %>% filter(Latitude >= min(p120_overlap_edt$Latitude) & Latitude <= max(p120_overlap_edt$Latitude) & Year >= min(p120_overlap_edt$Year) & Year <= max(p120_overlap_edt$Year))

#For each species and each dataset, loop through to see the overlapping gridIDs with the other datasets for each season, make this into a function! 
P915_total <- total_edt %>% filter(Survey %in% "P915")
P120_total <- total_edt %>% filter(Survey %in% "P120")
P195_total <- total_edt %>% filter(Survey %in% "P195")

spp_names <- unique(P915_total$Species) #wrong here: P195 
P915_total_spp <- list()
P915_total_gridID <- list()
P120_total_spp <- list()
P120_total_gridID <- list()
match_df <- list()

for(i in spp_names) {
P915_total_spp[[i]] <- P915_total %>% filter(Speciescommonname %in% i, Colnum > 0)
P915_total_gridID[[i]] <- P915_total_spp[[i]] %>% dplyr::select(gridID, Season, Speciescommonname) %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE)
P120_total_spp[[i]] <- P120_total %>% filter(Speciescommonname %in% i)
P120_total_gridID[[i]] <- P120_total_spp[[i]] %>% dplyr::select(gridID, Season, Speciescommonname) %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE)
match_df[[i]] <- match_df(P915_total_gridID[[i]], P120_total_gridID[[i]]) 
}

match_data <- as.data.frame(do.call(rbind, match_df))
match_data <- match_data %>% group_by(Speciescommonname, Season) %>% dplyr::mutate(count= n()) %>% distinct(count, .keep_all= TRUE)
match_data %>% summarise(mean= mean(count), sd= sd(count))
summary(match_data$count)

#For each Speciescommonname and each dataset, loop through to see the overlapping gridIDs with the other datasets for each season and year 

spp_names <- unique(P915_total$Speciescommonname) #wrong here: P195 
P915_total_spp <- list()
P915_total_gridID <- list()
P120_total_spp <- list()
P120_total_gridID <- list()
match_df <- list()

for(i in spp_names) {
P915_total_spp[[i]] <- P915_total %>% filter(Speciescommonname %in% i, Colnum > 0)
P915_total_gridID[[i]] <- P915_total_spp[[i]] %>% dplyr::select(gridID, Season, Speciescommonname, Year) %>% group_by(Season, Year, Speciescommonname) %>% distinct(gridID, .keep_all= TRUE)
P120_total_spp[[i]] <- P120_total %>% filter(Speciescommonname %in% i)
P120_total_gridID[[i]] <- P120_total_spp[[i]] %>% dplyr::select(gridID, Season, Speciescommonname, Year) %>% group_by(Season, Year, Speciescommonname) %>% distinct(gridID, .keep_all= TRUE)
match_df[[i]] <- match_df(P915_total_gridID[[i]], P120_total_gridID[[i]]) 
}

match_data2 <- as.data.frame(do.call(rbind, match_df))
match_data2 <- match_data2 %>% group_by(Speciescommonname, Season, Year) %>% dplyr::mutate(count= n()) %>% distinct(count, .keep_all= TRUE)
match_data2 %>% summarise(mean= mean(count), sd= sd(count))
summary(match_data2$count)
unique(match_data2$Year)
```

```{r}
select_spp2 <- c("atlantic croaker", "black drum", "blue catfish", "bonnethead hammerhead", "red drum", "sheepshead", "southern flounder", "southern kingfish", "striped bass")

#For each Speciescommonname and blue crabs, loop through to see the overlapping gridIDs with the other datasets for each season and year 

##Positive, positive
spp_names <- unique(P915_total$Speciescommonname)
P915_total_spp <- list()
P915_total_gridID <- list()
P120_total_gridID <- list()
match_df <- list()
library(plyr)
library(dplyr)
for(i in spp_names) {
P915_total_spp[[i]] <- P915_total %>% filter(Speciescommonname %in% i, Colnum > 0) %>% drop_na(Colnum)
P915_total_gridID[[i]] <- P915_total_spp[[i]] %>% dplyr::select(gridID, Season, Speciescommonname, Year) %>% group_by(Season, Year, Speciescommonname) %>% distinct(gridID, .keep_all= TRUE)
P120_bc <- P120_total %>% filter(Speciescommonname %in% "blue crab", Colnum > 0) %>% drop_na(Colnum)
P120_bc_gridID <- P120_bc %>% dplyr::select(gridID, Season, Speciescommonname, Year) %>% group_by(Season, Year, Speciescommonname) %>% distinct(gridID, .keep_all= TRUE)
match_df[[i]] <- match_df(P915_total_gridID[[i]], P120_bc_gridID, on = c("gridID", "Season", "Year")) 
}

detach(package:plyr)
library(dplyr)
match_data2 <- as.data.frame(do.call(rbind, match_df)) 
match_data2 <- match_data2 %>% group_by(Speciescommonname, Season, Year) %>% dplyr::mutate(count= n()) %>% select(-gridID) #count: number of observations overlapping for a predator species and blue crab for a season and year (includes all grid cells)

#pos, zero
##p915 first 
bc_pos <- P120_total %>% filter(Colnum > 0, Speciescommonname %in% "blue crab") %>% group_by(gridID, Season, Year) %>% mutate(bc_colnum= sum(Colnum)) %>% distinct(bc_colnum, .keep_all= F)
p915_zero <- P915_total %>% filter(Colnum == 0, Speciescommonname %in% select_spp2) %>% drop_na(Colnum) %>% dplyr::select(Year, Speciescommonname, Season, Colnum, gridID) %>% group_by(Season, Year, gridID, Speciescommonname) %>% distinct(Colnum) #only one row per species, gridID, season, and year b/c colnum= 0 
p915_zeroedt <- p915_zero %>% left_join(bc_pos, by = c("Year", "Season", "gridID")) #it's only gridIDs that overlap bc is the ones present in P915, NA for bc_colnum means it wasn't caught there so remove
pos_zero <- p915_zeroedt %>% drop_na(bc_colnum) 

##p120 first
pos_zero2 <- bc_pos %>% left_join(p915_zero, by = c("Year", "Season", "gridID")) %>% drop_na(Speciescommonname)

#zero, pos
##p915 first
bc_zero <- P120_total %>% filter(Colnum == 0, Speciescommonname %in% "blue crab") %>% drop_na(Colnum) %>% dplyr::select(Year, Speciescommonname, Season, Colnum, gridID) %>% group_by(gridID, Season, Year) %>% distinct(Colnum, .keep_all= F)
p915_pos <- P915_total %>% filter(Colnum > 0, Speciescommonname %in% select_spp2) %>% group_by(gridID, Season, Year, Speciescommonname) %>% mutate(pred_colnum = sum(Colnum)) %>% distinct(pred_colnum, .keep_all= F) #just need to get one row for a grid cell, season, year and species
zero_pos <- p915_pos %>% left_join(bc_zero, by= c("Year", "Season", "gridID")) %>% drop_na(Colnum) #exclude when blue crabs weren't sampled
##p120 first 
zero_pos2 <- bc_zero %>% left_join(p915_pos, by= c("Year", "Season", "gridID")) %>% drop_na(Speciescommonname) #exclude when blue crabs weren't sampled

library(arsenal)
summary(comparedf(zero_pos, zero_pos2))
#zero, zero
zero_zero <- p915_zero %>% select(-Colnum) %>% left_join(bc_zero, by= c("Year", "Season", "gridID")) %>% drop_na(Colnum) %>% group_by(Speciescommonname, Season, Year) %>% mutate(count= n()) #NAs are a grid cell where blue crab wasn't sampled, drop this, count gets at # of grid cells overlapping 
zero_zero2 <- bc_zero %>% select(-Colnum) %>% left_join(p915_zero, by= c("Year", "Season", "gridID")) %>% drop_na(Colnum) %>% group_by(Speciescommonname, Season, Year) %>% mutate(count= n())
```

##### Overlap tables: 
```{r}
##Summary tables
###Positive, positive 
match_data2edt <- match_data2edt %>% filter(!Speciescommonname %in% "blue crab", !Speciescommonname %in% "brown shrimp", !Speciescommonname %in% "white shrimp") %>% rename(Species= Speciescommonname)
match_data2edt %>% group_by(Species) %>% summarize(sum_spp = sum(sum_Colnum_pred), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_width(everything() ~ px(100)) %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/pospos.png")
match_data2edt %>% group_by(Species, Year) %>% summarize(sum_spp = sum(sum_Colnum_pred), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_width(everything() ~ px(100)) %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/pospos.year.pdf")
match_data2edt %>% group_by(Species, Year, Season) %>% summarize(sum_spp = sum(sum_Colnum_pred), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/pospos.year.season.pdf")

###Positive blue crab in P120, 0 predator in P915
P915_total_zeroedt2 <- P915_total_zeroedt %>% filter(!Speciescommonname %in% "blue crab", !Speciescommonname %in% "brown shrimp", !Speciescommonname %in% "white shrimp") %>% rename(Species= Speciescommonname)
P915_total_zeroedt2 %>% group_by(Species) %>% summarize(sum_spp = sum(Colnum), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_width(everything() ~ px(100)) %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/posneg.png")
P915_total_zeroedt2 %>% group_by(Species, Year) %>% summarize(sum_spp = sum(Colnum), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_width(everything() ~ px(100)) %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/posneg.year.pdf")
P915_total_zeroedt2 %>% group_by(Species, Year, Season) %>% summarize(sum_spp = sum(Colnum), sum_bc = sum(sum_Colnum_bc)) %>% gt() %>% cols_width(everything() ~ px(100)) %>% cols_align(align= "center") %>% gtsave(filename = "~/Desktop/posneg.season.pdf")
```

##### Overlap plots: 

```{r}
total_edt_new <- total_edt %>% filter(Speciescommonname %in% select_spp, !Area %in% "CAPEF", !Area %in% "NEWR", Year >= 2008, Season %in% "Spring"| Season %in% "Summer", Longitude > -77.0)

#Spatial overlap: including season 
sp_over_pos_pos("blue catfish") + ggtitle("Postive, positive: blue catfish") 
sp_over_pos_zero("blue catfish") + ggtitle("Postive, zero: blue catfish") 
sp_over_zero_pos("blue catfish") + ggtitle("Zero, positive: blue catfish")
sp_over_zero_zero("blue catfish") + ggtitle("Zero, zero: blue catfish") 

sp_over_pos_pos("bonnethead hammerhead") + ggtitle("Postive, positive: bonnethead")
sp_over_pos_zero("bonnethead hammerhead") + ggtitle("Postive, zero: bonnethead")
sp_over_zero_pos("bonnethead hammerhead") + ggtitle("Zero, positive: bonnethead")
sp_over_zero_zero("bonnethead hammerhead") + ggtitle("Zero, zero: bonnethead")

sp_over_pos_pos("black drum") + ggtitle("Postive, positive: black drum")
sp_over_pos_zero("black drum") + ggtitle("Postive, zero: black drum")
sp_over_zero_pos("black drum") + ggtitle("Zero, positive: black drum")
sp_over_zero_zero("black drum") + ggtitle("Zero, zero: black drum")

sp_over_pos_pos("red drum") + ggtitle("Postive, positive: red drum")
sp_over_pos_zero("red drum") + ggtitle("Postive, zero: red drum")
sp_over_zero_pos("red drum") + ggtitle("Zero, positive: red drum")
sp_over_zero_zero("red drum") + ggtitle("Zero, zero: red drum")

sp_over_pos_pos("oyster toadfish") + ggtitle("Postive, positive: oyster toadfish")
sp_over_pos_zero("oyster toadfish") + ggtitle("Postive, zero: oyster toadfish")
sp_over_zero_pos("oyster toadfish") + ggtitle("Zero, positive: oyster toadfish")
sp_over_zero_zero("oyster toadfish") + ggtitle("Zero, zero: oyster toadfish")

sp_over_pos_pos("striped bass") + ggtitle("Postive, positive: striped bass")
sp_over_pos_zero("striped bass") + ggtitle("Postive, zero: striped bass")
sp_over_zero_pos("striped bass") + ggtitle("Zero, positive: striped bass")
sp_over_zero_zero("striped bass") + ggtitle("Zero, zero: striped bass") 

#Temporal overlap
#histogram where count is the # of grid cells that overlap in year-month 
#pos, pos
match_data2 %>% filter(Speciescommonname %in% select_spp2) %>% ggplot() + geom_histogram(aes(x= Year)) + facet_wrap(~Speciescommonname + Season) + standard_theme #x= Year works because didn't summarize 
ggsave("/users/sallydowd/desktop/match.jpg", width=25, height= 25, units= c("cm")) 

#pos, zero: tried w/ pos_zero2 as well (no big differences)
pos_zero %>% ggplot() + geom_histogram(aes(x= Year)) + facet_wrap(~Speciescommonname + Season) + standard_theme
ggsave("/users/sallydowd/desktop/pos_zero.jpg", width=25, height= 25, units= c("cm")) 

#zero, pos: same graph no matter how left_join
zero_pos %>% ggplot() + geom_histogram(aes(x= Year)) + facet_wrap(~Speciescommonname + Season) + standard_theme
ggsave("/users/sallydowd/desktop/zero_pos.jpg", width=25, height= 25, units= c("cm")) 

#zero, zero: same graph no matter how left_join
zero_zero %>% filter(Speciescommonname %in% select_spp2) %>% ggplot() + geom_histogram(aes(x= Year)) + facet_wrap(~Speciescommonname + Season) + standard_theme #x= Year works because didn't summarize 
ggsave("/users/sallydowd/desktop/zerozero.jpg", width=25, height= 25, units= c("cm")) 
```

```{r}
#MAP of blue crab CPUE: in each grid cell, changing over time 
##p120
#Effort, all tows are 1 minute and speed adjusted to cover 75 yards, headrope is 10.5 feet, so area covered in one tow is 0.02195 hectares
summary(haul.shrimp$Duration)#only 1 minute tows, add ones for NAs
haul.shrimp=haul.shrimp%>%mutate(Duration=if_else(is.na(Duration),1,as.numeric(Duration)))

p120_bc_CPUE <- P120_total %>% filter(Speciescommonname %in% "blue crab") %>% mutate(CPUE= Colnum/0.02195) %>% group_by(Year, Latitude, Longitude) %>% mutate(avg_CPUE= mean(CPUE)) %>% distinct(avg_CPUE, .keep_all= TRUE)

ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + geom_point(data = p120_bc_CPUE, aes(x = Longitude, y = Latitude, size= avg_CPUE), colour= "orange") + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + facet_wrap(~Season) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude") 





test <- P120_total %>% filter(Speciescommonname %in% "blue crab") %>% mutate(CPUE= Colnum/0.02195) %>% filter(Season %in% "Summer") %>% group_by(Year, gridID) %>% mutate(avg_CPUE= mean(CPUE), long= mean(Longitude), lat= mean(Latitude))

a <- ggmap(myMap) + geom_point(data = test, aes(x = long, y = lat, color = avg_CPUE)) +
  # Here comes the gganimate specific bits
  labs(title = 'Summer Blue crab CPUE during {frame_time}') +
  transition_time(Year) 
gganimate::animate(a, duration = 12)
anim_save("~/Desktop/P195SpeciesOverTime.gif", width = 6, height = 4, unit = "in")
```

