---
title: "NCDMF overlap_exploration"
author: "Sally Dowd"
date: "06/05/23"
output: html_document
---

This code was adopted and modified from Sarah Roberts (sroberts@nyelab.org) who created it in 01/2022. 

#### Load packages, functions and datasets
```{r}
packages <- c("ggplot2", "tidyverse", "lubridate", "sf", "sp", "dplyr", "rnaturalearth", "readr", "readxl", "spatialEco")

invisible(lapply(packages, library, character.only= TRUE))

standard_theme <- theme_bw() + theme(panel.border = element_rect(fill=NA, colour = "black")) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.text.align= 0, legend.title= element_text(size = 12), legend.text = element_text(size= 10), axis.text=element_text(size=10), axis.title=element_text(size=12))

world <- ne_countries(scale = "medium", returnclass = "sf")
setwd("~/Documents/GitHub/NCBlueCrab_Predators")
p120 <- read.csv("Data/P120/Finalized/p120_clean_2021.csv") #make species name go to lower
p120_speciesn <- read.csv("Data/P120/P120_speciesnms.csv") 
p915 <- read.csv("Data/P915/Finalized/p915clean.csv")
p195 <- read.csv("Data/P195/Finalized/p195clean.csv")
colnames(p120) <- str_to_title(colnames(p120))
colnames(p195) <- str_to_title(colnames(p195))
p915$Date <- as.Date(paste(p915$Month, p915$Day, p915$Year, sep= "-"), "%m-%d-%Y")

colnames(p120)
colnames(p120_speciesn)

p120_speciesn <- p120_speciesn %>% rename("Species" = "SciName") %>% select(Species, SPECIESCOMMONNAME)
p120_edt <- p120 %>% left_join(p120_speciesn, by= "Species")
colnames(p120_edt) <- str_to_title(colnames(p120_edt))
p120_edt[[39]] <- tolower(p120_edt[[39]])
```

#### Where focal species are caught

```{r}
#P915
p915 %>% group_by(Species) %>% summarize(n= sum(as.numeric(Colnum)))

coords_captured <- function(species){
ggplot(data = world) + geom_sf() + geom_point(data = subset(p915, p915$Species %in% species & as.numeric(p915$Colnum > 0)), aes(x = as.numeric(Longitude), y = as.numeric(Latitude), colour = Colnum)) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude", colour= "# caught") + ggtitle(species)
}

coords_captured("bonnethead hammerhead")
coords_captured("blue crab") 
coords_captured("blue catfish") 
coords_captured("red drum") 
coords_captured("southern kingfish") 
coords_captured("southern flounder") 
coords_captured("striped bass")

#P120
p120_edt %>% group_by(Speciescommonname) %>% drop_na(Colnum) %>% summarize(n= sum(as.numeric(Colnum)))

coords_captured_p120 <- function(species){
ggplot(data = world) + geom_sf() + geom_point(data = subset(p120_edt, p120_edt$Speciescommonname %in% species), aes(x = as.numeric(Longdd), y = as.numeric(Latdd), colour = Colnum)) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + labs(x= "Longitude", y= "Latitude", colour= "# caught") + ggtitle(species)
}

coords_captured_p120("BLUE CRAB")
coords_captured_p120("NORTHERN BROWN SHRIMP")
coords_captured_p120("ATLANTIC CROAKER")
coords_captured_p120("BLUEFISH")
coords_captured_p120("RED DRUM")
coords_captured_p120("BLACK DRUM")
```

#### Bind together all datasets & explore  
```{r}
#Bind together 
p915_overlap <- p915 %>% dplyr::select(Date, Year, Month, Area, Ssal, Stemp, Sdo, Species, Colnum, Latitude, Longitude) %>% mutate(Survey= "P915", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)
p120_overlap <- p120_edt %>% dplyr::select(Date, Year, Month, Station, Surfacetemp, Surfacesal, Surfacedo, Speciescommonname, Colnum, Latdd, Longdd) %>% rename("Area" = "Station", "Stemp" = "Surfacetemp", "Ssal"= "Surfacesal", "Sdo"= "Surfacedo", "Latitude"= "Latdd", "Longitude" = "Longdd", "Species"= "Speciescommonname") %>% mutate(Survey= "P120", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)
p195_overlap <- p195 %>% dplyr::select(Date, Year, Month, Location, Tempsurface, Salinitysurface, Sdo, Speciescommonname, Numbertotal, Latitudestart, Longitudestart) %>% rename("Area"= "Location", "Stemp"= "Tempsurface", "Ssal"= "Salinitysurface", "Species"= "Speciescommonname", "Latitude"= "Latitudestart", "Longitude"= "Longitudestart", "Colnum"= "Numbertotal") %>% mutate(Survey= "P195", lat_lon= paste(Latitude, Longitude, sep= "_")) %>% drop_na(Latitude, Longitude)

colnames(p915_overlap)
colnames(p120_overlap)
colnames(p195_overlap)

total <- rbind(p915_overlap, p120_overlap, p195_overlap)
total$Ym_date <- format(total$Date, "%Y-%m")
total$Season <- ifelse(total$Month==4 | total$Month==5 | total$Month==6, "Spring", ifelse(total$Month==9 |total$Month==10 | total$Month==11 | total$Month==12, "Fall", ifelse(total$Month==7 |total$Month==8, "Summer", "Winter")))

#Explore 
total %>% group_by(Date, Survey, Latitude, Longitude) %>% summarize(abundance= mean(Colnum)) %>% ggplot() + geom_point(aes(x= Date, y= abundance, colour= Survey)) + standard_theme

ggplot() + geom_histogram(data = total, stat="count", aes(x=Ym_date, fill = Survey)) + standard_theme


#Reduce dataset for gridding 
p915_lat_lon <- p915_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
p120_lat_lon <- p120_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
p195_lat_lon <-p195_overlap %>% distinct(lat_lon, .keep_all= TRUE) %>% select(lat_lon, Latitude, Longitude) 
total_lat_lon <- rbind(p915_lat_lon, p120_lat_lon, p195_lat_lon)
```

#### Form a grid individually over datasets
```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")
# make an object the size and shape of the output you want
globe_bb <- matrix(c(-78.900147,33.802938,
                      -78.900147,36.672128,
                      -75.263672,36.672128,
                     -75.263672, 33.802938,
                     -78.900147,33.802938), byrow = TRUE, ncol = 2) %>% list() %>% st_polygon() %>% st_sfc(., crs = 4326)

globe_grid_20 <- st_make_grid(x= globe_bb, n = c(20,20), crs = 4326, what = 'polygons') %>% st_sf('geometry' = ., data.frame('ID' = 1:length(.)))

ggplot(data = world) + geom_sf() + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total, aes(x = Longitude, y = Latitude, colour = Survey), size = .2) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE)

fish_spat <- as.data.frame(total_lat_lon)
fish_spat$rowID <- 1:nrow(fish_spat)

coordinates(fish_spat) <- ~ Longitude + Latitude
fish_spat <- st_as_sf(fish_spat)
fish_spat <- st_set_crs(fish_spat, 4326)
grid <- globe_grid_20

fish_extract <- st_intersection(fish_spat, grid)
fish_extract_2 <- as.data.frame(fish_extract)
beep(sound= 8)

#Group to get rid of duplicates (there are times when a point is overlapping two grid cells)
fish_extract_2_2 <- fish_extract_2[!duplicated(fish_extract_2[c("rowID")]),] #this should be the same size as fish spat, it is 5 observations less, thinking this is bc a few datapoints might be outside of grid cells, didn't change in size from fish_extract_2
fish_extract_2_2$gridID <- fish_extract_2_2$ID

total_edt <- total %>% left_join(fish_extract_2_2, by= "lat_lon")
```

#### Edit gridded dataset
```{r}
#Check data: 74 data points have NA for grid cells, NA points as out of study area 
summary(is.na(total_edt))
ggplot(data = world) + geom_sf() + geom_sf(data = globe_grid_20, fill = NA) + coord_sf(xlim=c(-85, -70), ylim=c(25,40), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black")) + geom_point(data = total_edt %>% filter(gridID %in% NA), aes(x = Longitude, y = Latitude, colour = Survey), size = .2)

#Remove NA for gridID and Species, remove blank for species column 
total_edt <- total_edt %>% select(-ID, -geometry, rowID) %>% drop_na(gridID, Species)
colnames(total_edt)
total_edt[[8]] <- tolower(total_edt[[8]])

write.csv(total_edt, "/Users/sallydowd/Desktop/pamlicodatasets/total_edt.csv")
```

#### Overlap

##### Dataframe: spatial and temporal
```{r}
total_edt <- read.csv("/Users/sallydowd/Desktop/pamlicodatasets/total_edt.csv", header= T)
total_edt <- total_edt %>% select(-X)
select_spp <- c("atlantic croaker", "blue crab", "black drum", "blue catfish", "bonnethead hammerhead", "brown shrimp", "red drum", "sheepshead", "southern flounder", "southern kingfish", "striped bass", "white shrimp", "pink shrimp")
total_edt <- total_edt %>% filter(Species %in% select_spp)
p915_overlap_edt <- p915_overlap %>% filter(Species %in% select_spp)
p120_overlap[[8]] <- tolower(p120_overlap[[8]])
p120_overlap_edt <- p120_overlap %>% filter(Species %in% select_spp)
p195_overlap[[8]] <- tolower(p195_overlap[[8]])
p195_overlap_edt <- p195_overlap %>% filter(Species %in% select_spp)

total_edt_month <- total_edt %>% dplyr::select(-Season)
total_edt_seas <- total_edt %>% dplyr::select(-Month) 

#Explore grid cell occupancy 
##Number of observations (at least one species present) in each gridID
gridID_count <- total_edt %>% filter(Colnum > 0) %>% group_by(Survey, gridID) %>% summarize(count = n()) 

##Number of unique gridIDs with occupancy data
total_edt %>% filter(Survey %in% "P915", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID))
total_edt %>% filter(Survey %in% "P120", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID))
total_edt %>% filter(Survey %in% "P195", Colnum > 0) %>% summarize(count_distinct= n_distinct(gridID)) #number of unique 

##Overlapping grid IDs
###In general:
p915_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P915") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)
p120_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P120") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)
p195_overlap_gridID <- total_edt %>% select(gridID, Survey) %>% filter(Survey %in% "P195") %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID)

match_df(p915_overlap_gridID, p120_overlap_gridID, on = NULL)
match_df(p915_overlap_gridID, p195_overlap_gridID, on = NULL)
match_df(p195_overlap_gridID, p120_overlap_gridID, on = NULL) #results consistent when look at season 

###By season:
p915_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P915") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)
p120_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P120") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)
p195_overlap_gridIDs <- total_edt %>% select(gridID, Survey, Season) %>% filter(Survey %in% "P195") %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE) %>% select(gridID, Season)

match_df(p195_overlap_gridIDs %>% filter(Season %in% "Winter") %>% select(gridID), p120_overlap_gridIDs %>% filter(Season %in% "Winter") %>% select(gridID)) #tested with season and results were very similar 

#Grid, Month: Are there times when fish of the same species were caught at the same time (month, gridID and year) in each of the surveys? 
fish_grid_m <- total_edt_month %>% group_by(Year, Month, Species, Survey, gridID) %>% summarise(unique_fish = n_distinct(Colnum)) %>% pivot_wider(names_from = Survey, values_from = unique_fish) #n_distinct: counts unique combinations, how many times a fish was sampled in a grid cell 

#Grid, Season 
fish_grid_s <- total_edt_seas %>% group_by(Year, Season, Species, Survey, gridID) %>% summarise(unique_fish = n_distinct(Colnum)) %>% pivot_wider(names_from = Survey, values_from = unique_fish)
```

##### Basic spp visualzation
```{r}
#Species-specific 
ss_survey_vis <- function(species){
ggplot() + geom_sf(data = world) + geom_point(data = subset(total_edt, total_edt$Species %in% species & Colnum > 0), aes(x = Longitude, y = Latitude)) + scale_size_area() + facet_wrap(~Survey) + coord_sf(xlim=c(-78, -75), ylim=c(34,37), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))

}
ss_survey_vis("blue crab")
ss_survey_vis("bonnethead hammerhead")
ss_survey_vis("atlantic croaker")
ss_survey_vis("black drum")
ss_survey_vis("red drum")
ss_survey_vis("blue catfish")
ss_survey_vis("sheepshead")
ss_survey_vis("southern flounder")
ss_survey_vis("southern kingfish")
ss_survey_vis("striped bass")
ss_survey_vis("brown shrimp")
```

##### Overlap metrics

```{r}
#Overlapping lats and longs from both datasets 
p915_p120_lat_lon <- p915_overlap_edt %>% filter(Latitude >= min(p120_overlap_edt$Latitude) & Latitude <= max(p120_overlap_edt$Latitude) & Year >= min(p120_overlap_edt$Year) & Year <= max(p120_overlap_edt$Year))

p120_p915_lat_lon <- p120_overlap_edt %>% filter(Latitude >= min(p915_overlap_edt$Latitude) & Latitude <= max(p915_overlap_edt$Latitude) & Year >= min(p915_overlap_edt$Year) & Year <= max(p915_overlap_edt$Year))

p915_p195_lat_lon <- p915_overlap_edt %>% filter(Latitude >= min(p195_overlap_edt$Latitude) & Latitude <= max(p195_overlap_edt$Latitude) & Year >= min(p195_overlap_edt$Year) & Year <= max(p195_overlap_edt$Year))

p195_p120_lat_lon <- p195_overlap_edt %>% filter(Latitude >= min(p120_overlap_edt$Latitude) & Latitude <= max(p120_overlap_edt$Latitude) & Year >= min(p120_overlap_edt$Year) & Year <= max(p120_overlap_edt$Year))

#For each species and each dataset, loop through to see the overlapping gridIDs with the other datasets for each season, make this into a function! 
P915_total <- total_edt %>% filter(Survey %in% "P915")
P120_total <- total_edt %>% filter(Survey %in% "P120")
P195_total <- total_edt %>% filter(Survey %in% "P195")

spp_names <- unique(P195_total$Species)
P915_total_spp <- list()
P915_total_gridID <- list()
P120_total_spp <- list()
P120_total_gridID <- list()
match_df <- list()

for(i in spp_names) {
P915_total_spp[[i]] <- P915_total %>% filter(Species %in% i)
P915_total_gridID[[i]] <- P915_total_spp[[i]] %>% dplyr::select(gridID, Season, Species) %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE)
P120_total_spp[[i]] <- P120_total %>% filter(Species %in% i)
P120_total_gridID[[i]] <- P120_total_spp[[i]] %>% dplyr::select(gridID, Season, Species) %>% group_by(Season) %>% distinct(gridID, .keep_all= TRUE)
match_df[[i]] <- match_df(P915_total_gridID[[i]], P120_total_gridID[[i]]) 
}

match_data <- as.data.frame(do.call(rbind, match_df))
match_data <- match_data %>% group_by(Species, Season) %>% dplyr::mutate(count= n()) %>% distinct(count, .keep_all= TRUE)
match_data %>% summarise(mean= mean(count), sd= sd(count))
summary(match_data$count)

#For each species and each dataset, loop through to see the overlapping gridIDs with the other datasets for each season and year 

spp_names <- unique(P195_total$Species)
P915_total_spp <- list()
P915_total_gridID <- list()
P120_total_spp <- list()
P120_total_gridID <- list()
match_df <- list()

for(i in spp_names) {
P915_total_spp[[i]] <- P915_total %>% filter(Species %in% i)
P915_total_gridID[[i]] <- P915_total_spp[[i]] %>% dplyr::select(gridID, Season, Species, Year) %>% group_by(Season, Year, Species) %>% distinct(gridID, .keep_all= TRUE)
P120_total_spp[[i]] <- P120_total %>% filter(Species %in% i)
P120_total_gridID[[i]] <- P120_total_spp[[i]] %>% dplyr::select(gridID, Season, Species, Year) %>% group_by(Season, Year, Species) %>% distinct(gridID, .keep_all= TRUE)
match_df[[i]] <- match_df(P915_total_gridID[[i]], P120_total_gridID[[i]]) 
}

match_data2 <- as.data.frame(do.call(rbind, match_df))
match_data2 <- match_data2 %>% group_by(Species, Season, Year) %>% dplyr::mutate(count= n()) %>% distinct(count, .keep_all= TRUE)
match_data2 %>% summarise(mean= mean(count), sd= sd(count))
summary(match_data2$count)
unique(match_data2$Year)
```



how many trawls are in the overlapping data? 
```{r}
length(unique(neus_me$haulid))
length(unique(neus_overlap_lat$haulid))

length(unique(seus_overlap_lat$haulid))
length(unique(seus_me$haulid))
```
add lon
```{r}
neus_overlap <- neus_me %>% dplyr::filter(lat >= min(seus_me$lat) & lat <= max(seus_me$lat) & lon >= min(seus_me$lon) & lon <= max(seus_me$lon) & year >= min(seus_me$year) & year <= max(seus_me$year))

seus_overlap <- seus_me %>% dplyr::filter(lat >= min(neus_me$lat) & lat <= max(neus_me$lat) & lon >= min(neus_me$lon) & lon <= max(neus_me$lon) &year >= min(neus_me$year) & year <= max(neus_me$year))
```


how many trawls are in the overlapping data? 
```{r}
length(unique(neus_me$haulid))
length(unique(neus_overlap$haulid))

length(unique(seus_overlap$haulid))
length(unique(seus_me$haulid))
```

overlapping species in lat, year overlap 
```{r}
#lat and year 
neus_overlap_specs <- neus_overlap_lat %>% dplyr::filter(spp %in% seus_overlap_lat$spp)

seus_overlap_specs <- seus_overlap_lat %>% dplyr::filter(spp %in% neus_overlap_lat$spp)

length(unique(neus_overlap_specs$spp))
length(unique(seus_overlap_specs$spp))

#lat, lon and year 
neus_overlap_specs <- neus_overlap %>% dplyr::filter(spp %in% seus_overlap$spp)

seus_overlap_specs <- seus_overlap %>% dplyr::filter(spp %in% neus_overlap$spp)

length(unique(neus_overlap_specs$spp))
length(unique(seus_overlap_specs$spp))

library(lubridate)
neus_me$month <- month(as.POSIXlt(neus_me$date))

neus_seust_overlap <- neus_overlap_specs
```



#reef data 
```{r}
Reef <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/SEAMAP/Reef_Fish_Survey_Jan_2022.csv")
Reef[] <- lapply(Reef, gsub, pattern='=', replacement='') #= was in front of a lot of characters

Reef <- Reef %>% 
  mutate(date = as.Date(DATE, "%m-%d-%Y"), 
         month = month(date), 
         year = year(date),
         year = as.numeric(year),
         lat = as.numeric(LATITUDESTART), 
         lon = as.numeric(LONGITUDESTART), 
         spp = SPECIESSCIENTIFICNAME, 
         haulid = COLLECTIONNUMBER)%>% 
  drop_na(lat,lon)

ggplot() + geom_histogram(data = Reef, aes(x=date, fill = as.factor(month)), binwidth = 30) +
       scale_x_date(labels = date_format("%Y-%b"), breaks = "6 months") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ scale_fill_brewer(palette = "Set1")

ggplot(data = world) + geom_sf() + geom_point(data = Reef, aes(x = lon, y = lat, colour = as.factor(month)), size = .2) + 
    coord_sf(xlim=c(-85, -75), ylim=c(27,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))+ scale_colour_brewer(palette = "Set1")+ guides(colour = guide_legend(override.aes = list(size=5)))

```


get out just overlapping lat longs and year from both datasets 

```{r}
neus_overlap_lat <- neus_me %>% dplyr::filter(lat >= min(Reef$lat) & lat <= max(Reef$lat) &  year >= min(Reef$year) & year <= max(Reef$year))

Reef_overlap_lat <- Reef %>% dplyr::filter(lat >= min(neus_me$lat) & lat <= max(neus_me$lat) & year >= min(neus_me$year) & year <= max(neus_me$year))
```


how many trawls are in the overlapping data? 
```{r}
length(unique(neus_me$haulid))
length(unique(neus_overlap_lat$haulid))

length(unique(Reef_overlap_lat$haulid))
length(unique(Reef$haulid))
```
add lon
```{r}
neus_overlap <- neus_me %>% dplyr::filter(lat >= min(Reef$lat) & lat <= max(Reef$lat) & lon >= min(Reef$lon) & lon <= max(Reef$lon) & year >= min(Reef$year) & year <= max(Reef$year))

Reef_overlap <- Reef %>% dplyr::filter(lat >= min(neus_me$lat) & lat <= max(neus_me$lat) & lon >= min(neus_me$lon) & lon <= max(neus_me$lon) &year >= min(neus_me$year) & year <= max(neus_me$year))
```


how many trawls are in the overlapping data? 
```{r}
length(unique(neus_me$haulid))
length(unique(neus_overlap$haulid))

length(unique(Reef_overlap$haulid))
length(unique(Reef$haulid))
```

overlapping species in lat, year overlap 
```{r}
#lat and year 
neus_overlap_specs <- neus_overlap_lat %>% dplyr::filter(spp %in% Reef_overlap_lat$spp)

Reef_overlap_specs <- Reef_overlap_lat %>% dplyr::filter(spp %in% neus_overlap_lat$spp)

length(unique(neus_overlap_specs$spp))
length(unique(Reef_overlap_specs$spp))

#lat, lon and year 
neus_overlap_specs <- neus_overlap %>% dplyr::filter(spp %in% Reef_overlap$spp)

Reef_overlap_specs <- Reef_overlap %>% dplyr::filter(spp %in% neus_overlap$spp)

length(unique(neus_overlap_specs$spp))
length(unique(Reef_overlap_specs$spp))

neus_seusR_overlap <- neus_overlap_specs


```

reef event info 
```{r}
Reef_event <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/SEAMAP/Reef_Fish_event_Jan_2022.csv")
```



#temporal piece 
Figure out if the overlapping data has similar time frames
```{r}
library(scales) 
neus_seusR_overlap
Reef_overlap_specs

neus_seust_overlap
seus_overlap_specs


ggplot() + geom_histogram(data = neus_seusR_overlap, aes(x=date), binwidth = 30) +
       scale_x_date(labels = date_format("%Y-%b"))

```



#longline data 
```{r}
longline <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/SEAMAP/Longline_Fish_Survey_Jan_2022.csv")
longline[] <- lapply(longline, gsub, pattern='=', replacement='') #= was in front of a lot of characters

longline <- longline %>% 
  mutate(date = as.Date(DATE, "%m-%d-%Y"), 
         month = month(date), 
         year = year(date),
         year = as.numeric(year),
         lat = as.numeric(LATITUDESTART), 
         lon = as.numeric(LONGITUDESTART), 
         spp = SPECIESCOMMONNAME, 
         haulid = COLLECTIONNUMBER, 
         duration = as.numeric(DURATION), 
         weight = as.numeric(SPECIESTOTALWEIGHT),
         NUMBERTOTAL = as.numeric(NUMBERTOTAL),
         bt = as.numeric(TEMPBOTTOM), 
         sst = as.numeric(TEMPSURFACE), 
         bsal = as.numeric(SALINITYBOTTOM), 
         ssal = as.numeric(SALINITYSURFACE), 
         haulid = EVENTNAME, 
         effort = as.numeric(EFFORT))%>% 
  drop_na(lat,lon, weight, spp)

#checkit
library(rnaturalearth)
world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) + geom_sf() + geom_point(data =  longline, aes(x = lon, y = lat)) + 
    coord_sf(xlim=c(-85, -75), ylim=c(28,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))

ggplot(data = world) + geom_sf() + geom_point(data =  subset(longline, longline$SPECIESCOMMONNAME == "BONNETHEAD"), aes(x = lon, y = lat)) + 
    coord_sf(xlim=c(-85, -75), ylim=c(28,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))
```

```{r}
#make wider 
longline <- longline %>% filter(spp != "")
# sum different sexes of same spp together
#okay so now we know that the biomass column was given to them as the calibrated cpue
longline <- longline %>% 
  group_by(year, lat, lon, date, month, EVENTNAME, bt, sst, bsal, ssal, duration, spp, effort) %>% 
  summarise(weight = sum(weight)) 

longline$wtcpue <- longline$weight / longline$effort

longline$spp <- gsub(pattern = " ", replacement = "", longline$spp)

longline_wide <- pivot_wider(longline, names_from = spp, values_from = wtcpue)
 #with more than 20% NA


#convert NA to 0 
longline_wide[, 14:ncol(longline_wide)][is.na(longline_wide[, 14:ncol(longline_wide)])] <- 0


#group by haulid 

longline_wide <- longline_wide %>%
  group_by(year, lat, lon, date, month, EVENTNAME, bt, sst, bsal, ssal, duration, effort) %>% 
  summarise_if(is.numeric, mean, na.rm = TRUE)

longline_wide <- longline_wide %>% dplyr::select(-weight)

ggplot(data = world) + geom_sf() + geom_point(data = subset(longline_wide, ATLANTICSHARPNOSESHARK>0), aes(x = lon, y = lat, colour = ATLANTICSHARPNOSESHARK)) + 
    coord_sf(xlim=c(-85, -75), ylim=c(28,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))


colSums(longline_wide != 0)
```


#video data 
```{r}
video <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/SERFS_Video/video.dataset.2011.2021.subset.csv")

#make it long 
video_long <- video %>% pivot_longer(cols = Alopias.sp_: Thunnus.sp_, names_to = "spp", values_to = "abd")
tallied <- video_long %>% filter(abd > 0) %>% group_by(spp) %>% tally()

ggplot(data = world) + geom_sf() + geom_point(data = video, aes(x = Start_Longitude, y = Start_Latitude)) + 
    coord_sf(xlim=c(-85, -75), ylim=c(28,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))
```


Carcharhinus.plumbeus = sandbarshark, 133 positive abundances 
Ginglymostoma.cirratum = nurse shark, 176 positive abundances 
Galeocerdo.cuvier = tiger shar, 74 positive abundances
Rhizoprionodon.terraenovae = sharpnose shark, 427 positive abundances 

```{r}
ham_summer <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/DISMAP/scalloped_hammerhead_survey-points-data.csv")
colnames(ham_summer) <- c("HaulID", "Stratum", "LAT", "LON", "Depth", "Year", "wtcpue")
ham_summer <- ham_summer[-c(1, 2, 3), ] 
ham_summer <- ham_summer %>% mutate(LAT = as.numeric(LAT), LON = as.numeric(LON), wtcpue = as.numeric(wtcpue))
pos_summer <- ham_summer %>% filter(wtcpue > 0)
ham_spring <- read.csv("~/Documents/ClimateOceanPlanning/Datasets/DISMAP/scalloped_hammerhead_spring_survey-points-data.csv")
colnames(ham_spring) <- c("HaulID", "Stratum", "LAT", "LON", "Depth", "Year", "wtcpue")
ham_spring <- ham_spring[-c(1, 2, 3), ] 
pos_spring <- ham_spring %>% filter(wtcpue > 0)


ggplot(data = world) + geom_sf() + geom_point(data = ham_summer, aes(x = LON, y = LAT)) + 
    coord_sf(xlim=c(-85, -75), ylim=c(28,36), expand = TRUE) + theme(panel.background = element_rect(fill = "white", colour = "black"))
```

#### Other analyses: Centroid shifts, Fuzzy logic (see Example_survey_overlap.Rmd) 
