---
title: "GAMs_final_real"
format: html
editor: visual
---

```{r}
source("~/Documents/GitHub/NCBlueCrab_Predators/Scripts/Load.SDM.Final.R")
```

-https://docs.h2o.ai/h2o/latest-stable/h2o-docs/data-science/algo-params/tweedie_link_power.html
-Used tweedie with log link: https://www.ccamlr.org/ru/system/files/science_journal_papers/04candy.pdf

#### Red drum 
##### Models 
```{r}
#Red drum 
reddrum_env <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor), family= tw(link= "log",), data=df_CPUE_length_wide_both)
summary(reddrum_env)

reddrum_env_bc <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(smallbluecrabP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(reddrum_env_bc)

reddrum_env_forage <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(reddrumP915forageP915) + s(reddrumP915forageP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(reddrum_env_forage)

reddrum_env_bc_forage <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(reddrumP915forageP120) + s(reddrumP915forageP915) + s(smallbluecrabP120), family= tw(link= "log"),  data=df_CPUE_length_wide_both)
summary(reddrum_env_bc_forage)

AIC(reddrum_env, reddrum_env_bc, reddrum_env_forage, reddrum_env_bc_forage) %>% arrange(AIC)

#tw(): p is estimated during fitting, will report this 
```

##### Diagnostics
-Interpret partial effect plots: https://towardsdatascience.com/producing-insights-with-generalized-additive-models-gams-cf2b68b1b847
```{r}
gam.check(reddrum_env)
gam.check(reddrum_env_bc)
gam.check(reddrum_env_forage)
gam.check(reddrum_env_bc_forage)

#Partial effect plots
plot(reddrum_env, shade= "true") 
plot(reddrum_env_bc, shade= "true") 
plot(reddrum_env_forage, shade= "true") 
plot(reddrum_env_bc_forage, shade= "true") 

#Marginal effect plots

#Look at GLMs for prediction with log link 
test <- as.data.frame(predict(reddrum_env), df_CPUE_length_wide_both, type= "response")
colnames(test) <- "prediction"
test <- test %>% mutate(pred2= exp(prediction)) #get predictions on correct scale 

df <- df_CPUE_length_wide_both %>% dplyr::select(avgdepth, avgssal, avgstemp, avgsdo, SAVkm, NoFishRest, Yearfactor, reddrumP915)
bind <- bind_cols(df, test)

bind %>% ggplot(aes(x= avgssal, y= pred2)) + geom_point() stat_smooth(method = "gam", formula = re ~ s(x), method.args = list(fit = gam_model))


  s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor)
  
  plot(reddrum_env, select = 1, shade = TRUE, main = "avgssal") #partial effect plots: show component effect of each of smooth or linear terms in model, centered around mean: increase or decrease in y axis is reflected in average predicted value of response, if above 0 than higher than average, decrease in ssal decreases # of reddrum 


lets_see <- bind %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, SAVkm, NoFishRest, Yearfactor, reddrumP915), names_to= "predictor")

lets_see %>% ggplot(aes(value, reddrumP915)) + geom_point() + geom_smooth(method= "loess") + facet_wrap(~predictor, scales= "free") + standard_theme
#plot predictor variable effects 
#plot marginal effects of each covariate
#max k is total # of observations for a covariate - 1 
#covariate effect plots 
```

#### Southern kingfish

##### Models 
```{r}
southernkingfish_env <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(southernkingfish_env)

southernkingfish_env_bc <- gam(southernkingfishP915 ~ s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(smallbluecrabP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(southernkingfish_env_bc)

southernkingfish_env_forage <- gam(southernkingfishP915 ~ s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(southernkingfishP915forageP915) + s(southernkingfishP915forageP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(southernkingfish_env_forage)

southernkingfish_env_bc_forage <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(southernkingfishP915forageP120) + s(southernkingfishP915forageP915) + s(smallbluecrabP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(southernkingfish_env_bc_forage)

AIC(southernkingfish_env, southernkingfish_env_bc, southernkingfish_env_forage, southernkingfish_env_bc_forage) %>% arrange(AIC)
```

```{r}
#Black drum
blackdrum_env <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(blackdrum_env)

blackdrum_env_bc <- gam(blackdrumP915 ~ s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(smallbluecrabP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(blackdrum_env_bc)

blackdrum_env_forage <- gam(blackdrumP915 ~ s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(blackdrumP915forageP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(blackdrum_env_forage)

blackdrum_env_bc_forage <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(SAVkm)+s(NoFishRest)+factor(Yearfactor) + s(blackdrumP915forageP120) + s(smallbluecrabP120), family= tw(link= "log"), data=df_CPUE_length_wide_both)
summary(blackdrum_env_bc_forage)

AIC(blackdrum_env, blackdrum_env_bc, blackdrum_env_forage, blackdrum_env_bc_forage) %>% arrange(AIC)
```
