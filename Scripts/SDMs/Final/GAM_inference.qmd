---
title: "GAM_inference"
format: html
editor: visual
---

```{r}
source("~/Documents/GitHub/NCBlueCrab_Predators/Scripts/Load.SDM.Final.R")
```

#### Red drum

##### Models

```{r}
reddrum_env <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

reddrum_bc <- gam(reddrumP915~ s(log(smallbluecrabP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

reddrum_forage <- gam(reddrumP915~ s(log(reddrumP915forageP915+1)) + s(log(reddrumP915forageP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

reddrum_env_bc <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(smallbluecrabP120+1)), family= tw(), data=df_CPUE_length_wide_both)

reddrum_env_forage <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(reddrumP915forageP915+1)) + s(log(reddrumP915forageP120+1)), family= tw(), data=df_CPUE_length_wide_both)

reddrum_env_bc_forage <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(reddrumP915forageP120+1)) + s(log(reddrumP915forageP915+1)) + s(log(smallbluecrabP120+1)), family= tw(),  data=df_CPUE_length_wide_both)

AIC(reddrum_env, reddrum_bc, reddrum_forage, reddrum_env_bc, reddrum_env_forage, reddrum_env_bc_forage) %>% arrange(AIC)
```

##### Diagnostics

```{r}
summary(reddrum_env)
summary(reddrum_bc)
summary(reddrum_forage)
summary(reddrum_env_bc)
summary(reddrum_env_forage)
summary(reddrum_env_bc_forage)

anova(reddrum_env) #p-value for year variable across all years
anova(reddrum_bc)
anova(reddrum_forage)
anova(reddrum_env_bc)
anova(reddrum_env_forage)
anova(reddrum_env_bc_forage)

gam.check(reddrum_env)
gam.check(reddrum_bc)
gam.check(reddrum_forage)
gam.check(reddrum_env_bc)
gam.check(reddrum_env_forage)
gam.check(reddrum_env_bc_forage)

vif(reddrum_env)
vif(reddrum_bc)
vif(reddrum_forage)
vif(reddrum_env_bc)
vif(reddrum_env_forage)
vif(reddrum_env_bc_forage)

cor(df_CPUE_length_wide_both %>% dplyr::select(avgdepth,avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915forageP915, reddrumP915forageP120, smallbluecrabP120))

#Partial effect plots
plot(reddrum_env, shade= "true") 
plot(reddrum_bc, shade= "true") 
plot(reddrum_forage, shade= "true") 
plot(reddrum_env_bc, shade= "true") 
plot(reddrum_env_forage, shade= "true") 
plot(reddrum_env_bc_forage, shade= "true") 

#Predictions
df_env <- pred_gam(reddrum_env, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, reddrumP915))
df_env_long <- df_env %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915), names_to= "predictor")
graphs(df_env_long, df_env)

ggplot(df_CPUE_length_wide_both) + geom_point() + 

df_bc <- pred_gam(reddrum_bc, c(smallbluecrabP120, Yearfactor, reddrumP915))
df_bc$smallbluecrabP120 <- log(df_bc$smallbluecrabP120+1)
df_bc_long <- df_bc %>% pivot_longer(cols= c(smallbluecrabP120, reddrumP915), names_to= "predictor")
graphs(df_bc_long, df_bc)

df_forage <- pred_gam(reddrum_forage, c(reddrumP915forageP915, reddrumP915forageP120, Yearfactor, reddrumP915))
df_forage$reddrumP915forageP915 <- log(df_forage$reddrumP915forageP915+1)
df_forage$reddrumP915forageP120 <- log(df_forage$reddrumP915forageP120+1)
df_forage_long <- df_forage %>% pivot_longer(cols= c(reddrumP915forageP915, reddrumP915forageP120, reddrumP915), names_to= "predictor")
graphs(df_forage_long, df_forage)

df_env_bc <- pred_gam(reddrum_env_bc, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, reddrumP915, smallbluecrabP120))
df_env_bc$smallbluecrabP120 <- log(df_env_bc$smallbluecrabP120+1)
df_env_bc_long <- df_env_bc %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_long, df_env_bc)
ggsave("/users/sallydowd/Desktop/Ch1Data/Final_results/GAMs/reddrumbest_partial.jpeg", width= 10, height= 8)
df_env_forage <- pred_gam(reddrum_env_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915, reddrumP915forageP915, reddrumP915forageP120))
df_env_forage$reddrumP915forageP915 <- log(df_env_forage$reddrumP915forageP915+1)
df_env_forage$reddrumP915forageP120 <- log(df_env_forage$reddrumP915forageP120+1)
df_env_forage_long <- df_env_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915, reddrumP915forageP915, reddrumP915forageP120), names_to= "predictor")
graphs(df_env_forage_long, df_env_forage)
df_env_bc_forage <- pred_gam(reddrum_env_bc_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915, reddrumP915forageP915, reddrumP915forageP120, smallbluecrabP120))
df_env_bc_forage$smallbluecrabP120 <- log(df_env_bc_forage$smallbluecrabP120+1)
df_env_bc_forage$reddrumP915forageP915 <- log(df_env_bc_forage$reddrumP915forageP915+1)
df_env_bc_forage$reddrumP915forageP120 <- log(df_env_bc_forage$reddrumP915forageP120+1)
df_env_bc_forage_long <- df_env_bc_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, reddrumP915, reddrumP915forageP915, reddrumP915forageP120, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_forage_long, df_env_bc_forage)
```

##### year as numeric
```{r}
reddrum_env2 <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+s(Year), family= tw(), data=df_CPUE_length_wide_both)
plot(reddrum_env2, shade= "true") 

blackdrum_env2 <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+s(Year), family= tw(), data=df_CPUE_length_wide_both)
plot(blackdrum_env2, shade= "true") 

blackdrum_env2 <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+s(Year) + s(log(smallbluecrabP120+1)), family= tw(), data=df_CPUE_length_wide_both)
plot(blackdrum_env2, shade= "true") 
```

#### Southern kingfish

##### Models

```{r}
southernkingfish_env <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

southernkingfish_bc <- gam(southernkingfishP915~ s(log(smallbluecrabP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

southernkingfish_forage <- gam(southernkingfishP915~ s(log(southernkingfishP915forageP915+1)) + s(log(southernkingfishP915forageP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

southernkingfish_env_bc <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(smallbluecrabP120+1)), family= tw(), data=df_CPUE_length_wide_both)

southernkingfish_env_forage <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(southernkingfishP915forageP915+1)) + s(log(southernkingfishP915forageP120+1)), family= tw(), data=df_CPUE_length_wide_both)

southernkingfish_env_bc_forage <- gam(southernkingfishP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(southernkingfishP915forageP120+1)) + s(log(southernkingfishP915forageP915+1)) + s(log(smallbluecrabP120+1)), family= tw(),  data=df_CPUE_length_wide_both)

AIC(southernkingfish_env, southernkingfish_bc, southernkingfish_forage, southernkingfish_env_bc, southernkingfish_env_forage, southernkingfish_env_bc_forage) %>% arrange(AIC)

#Warning: algorithm can't take a step in parameter space that would result in an improvement in the optimizaiton criterion
#technique: increase k until doesn't fail anymore 
```

##### Diagnostics

```{r}
summary(southernkingfish_env)
summary(southernkingfish_bc)
summary(southernkingfish_forage)
summary(southernkingfish_env_bc)
summary(southernkingfish_env_forage)
summary(southernkingfish_env_bc_forage)

anova(southernkingfish_env) #p-value for year variable across all years
anova(southernkingfish_bc)
anova(southernkingfish_forage)
anova(southernkingfish_env_bc)
anova(southernkingfish_env_forage)
anova(southernkingfish_env_bc_forage)

gam.check(southernkingfish_env)
gam.check(southernkingfish_bc)
gam.check(southernkingfish_forage)
gam.check(southernkingfish_env_bc)
gam.check(southernkingfish_env_forage)
gam.check(southernkingfish_env_bc_forage)

vif(southernkingfish_env)
vif(southernkingfish_bc)
vif(southernkingfish_forage)
vif(southernkingfish_env_bc)
vif(southernkingfish_env_forage)
vif(southernkingfish_env_bc_forage)

cor(df_CPUE_length_wide_both %>% dplyr::select(avgdepth,avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915forageP915, southernkingfishP915forageP120, smallbluecrabP120))

#Partial effect plots
plot(southernkingfish_env, shade= "true") 
plot(southernkingfish_bc, shade= "true") 
plot(southernkingfish_forage, shade= "true") 
plot(southernkingfish_env_bc, shade= "true") 
plot(southernkingfish_env_forage, shade= "true") 
plot(southernkingfish_env_bc_forage, shade= "true") 

#Predictions
df_env <- pred_gam(southernkingfish_env, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, southernkingfishP915))
df_env_long <- df_env %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915), names_to= "predictor")
graphs(df_env_long, df_env)

df_bc <- pred_gam(southernkingfish_bc, c(smallbluecrabP120, Yearfactor, southernkingfishP915))
df_bc$smallbluecrabP120 <- log(df_bc$smallbluecrabP120+1)
df_bc_long <- df_bc %>% pivot_longer(cols= c(smallbluecrabP120, southernkingfishP915), names_to= "predictor")
graphs_sk(df_bc_long, df_bc)

df_forage <- pred_gam(southernkingfish_forage, c(southernkingfishP915forageP915, southernkingfishP915forageP120, Yearfactor, southernkingfishP915))
df_forage$southernkingfishP915forageP915 <- log(df_forage$southernkingfishP915forageP915+1)
df_forage$southernkingfishP915forageP120 <- log(df_forage$southernkingfishP915forageP120+1)
df_forage_long <- df_forage %>% pivot_longer(cols= c(southernkingfishP915forageP915, southernkingfishP915forageP120, southernkingfishP915), names_to= "predictor")
graphs(df_forage_long, df_forage)

df_env_bc <- pred_gam(southernkingfish_env_bc, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, southernkingfishP915, smallbluecrabP120))
df_env_bc$smallbluecrabP120 <- log(df_env_bc$smallbluecrabP120+1)
df_env_bc_long <- df_env_bc %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_long, df_env_bc)

df_env_forage <- pred_gam(southernkingfish_env_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915, southernkingfishP915forageP915, southernkingfishP915forageP120))
df_env_forage$southernkingfishP915forageP915 <- log(df_env_forage$southernkingfishP915forageP915+1)
df_env_forage$southernkingfishP915forageP120 <- log(df_env_forage$southernkingfishP915forageP120+1)
df_env_forage_long <- df_env_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915, southernkingfishP915forageP915, southernkingfishP915forageP120), names_to= "predictor")
graphs(df_env_forage_long, df_env_forage)

df_env_bc_forage <- pred_gam(southernkingfish_env_bc_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915, southernkingfishP915forageP915, southernkingfishP915forageP120, smallbluecrabP120))
df_env_bc_forage$smallbluecrabP120 <- log(df_env_bc_forage$smallbluecrabP120+1)
df_env_bc_forage$southernkingfishP915forageP915 <- log(df_env_bc_forage$southernkingfishP915forageP915+1)
df_env_bc_forage$southernkingfishP915forageP120 <- log(df_env_bc_forage$southernkingfishP915forageP120+1)
df_env_bc_forage_long <- df_env_bc_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, southernkingfishP915, southernkingfishP915forageP915, southernkingfishP915forageP120, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_forage_long, df_env_bc_forage)
```

#### Black drum

##### Models

```{r}
blackdrum_env <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

blackdrum_bc <- gam(blackdrumP915~ s(log(smallbluecrabP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

blackdrum_forage <- gam(blackdrumP915~ s(log(blackdrumP915forageP120+1)) + factor(Yearfactor), family= tw(), data=df_CPUE_length_wide_both)

blackdrum_env_bc <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(smallbluecrabP120+1)), family= tw(), data=df_CPUE_length_wide_both)

blackdrum_env_forage <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(blackdrumP915forageP120+1)), family= tw(), data=df_CPUE_length_wide_both)

blackdrum_env_bc_forage <- gam(blackdrumP915~s(avgdepth)+s(avgssal)+s(avgstemp) + s(avgsdo)+s(NoFishRest)+factor(Yearfactor) + s(log(blackdrumP915forageP120+1)) + s(log(smallbluecrabP120+1)), family= tw(),  data=df_CPUE_length_wide_both)

AIC(blackdrum_env, blackdrum_bc, blackdrum_forage, blackdrum_env_bc, blackdrum_env_forage, blackdrum_env_bc_forage) %>% arrange(AIC)
```

##### Diagnostics

```{r}
summary(blackdrum_env)
summary(blackdrum_bc)
summary(blackdrum_forage)
summary(blackdrum_env_bc)
summary(blackdrum_env_forage)
summary(blackdrum_env_bc_forage)

anova(blackdrum_env) #p-value for year variable across all years
anova(blackdrum_bc)
anova(blackdrum_forage)
anova(blackdrum_env_bc)
anova(blackdrum_env_forage)
anova(blackdrum_env_bc_forage)

gam.check(blackdrum_env)
gam.check(blackdrum_bc)
gam.check(blackdrum_forage)
gam.check(blackdrum_env_bc)
gam.check(blackdrum_env_forage)
gam.check(blackdrum_env_bc_forage)

vif(blackdrum_env)
vif(blackdrum_bc)
vif(blackdrum_forage)
vif(blackdrum_env_bc)
vif(blackdrum_env_forage)
vif(blackdrum_env_bc_forage)

cor(df_CPUE_length_wide_both %>% dplyr::select(avgdepth,avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915forageP120, smallbluecrabP120))

#Partial effect plots
plot(blackdrum_env, shade= "true") 
plot(blackdrum_bc, shade= "true") 
plot(blackdrum_forage, shade= "true") 
plot(blackdrum_env_bc, shade= "true") 
plot(blackdrum_env_forage, shade= "true") 
plot(blackdrum_env_bc_forage, shade= "true") 

#Predictions
df_env <- pred_gam(blackdrum_env, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, blackdrumP915))
df_env_long <- df_env %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915), names_to= "predictor")
graphs(df_env_long, df_env)

df_bc <- pred_gam(blackdrum_bc, c(smallbluecrabP120, Yearfactor, blackdrumP915))
df_bc$smallbluecrabP120 <- log(df_bc$smallbluecrabP120+1)
df_bc_long <- df_bc %>% pivot_longer(cols= c(smallbluecrabP120, blackdrumP915), names_to= "predictor")
graphs(df_bc_long, df_bc)

df_forage <- pred_gam(blackdrum_forage, c(blackdrumP915forageP120, Yearfactor, blackdrumP915))
df_forage$blackdrumP915forageP120 <- log(df_forage$blackdrumP915forageP120+1)
df_forage_long <- df_forage %>% pivot_longer(cols= c(blackdrumP915forageP120, blackdrumP915), names_to= "predictor")
graphs(df_forage_long, df_forage)

df_env_bc <- pred_gam(blackdrum_env_bc, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, Yearfactor, blackdrumP915, smallbluecrabP120))
df_env_bc$smallbluecrabP120 <- log(df_env_bc$smallbluecrabP120+1)
df_env_bc_long <- df_env_bc %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_long, df_env_bc)

df_env_forage <- pred_gam(blackdrum_env_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915, blackdrumP915forageP120))
df_env_forage$blackdrumP915forageP120 <- log(df_env_forage$blackdrumP915forageP120+1)
df_env_forage_long <- df_env_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915, blackdrumP915forageP120), names_to= "predictor")
graphs(df_env_forage_long, df_env_forage)
ggsave("/users/sallydowd/Desktop/Ch1Data/Final_results/GAMs/blackdrumbest_partial.jpeg", width= 10, height= 8)
df_env_bc_forage <- pred_gam(blackdrum_env_bc_forage, c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915, blackdrumP915forageP120, smallbluecrabP120))
df_env_bc_forage$smallbluecrabP120 <- log(df_env_bc_forage$smallbluecrabP120+1)
df_env_bc_forage$blackdrumP915forageP120 <- log(df_env_bc_forage$blackdrumP915forageP120+1)
df_env_bc_forage_long <- df_env_bc_forage %>% pivot_longer(cols= c(avgdepth, avgssal, avgstemp, avgsdo, NoFishRest, blackdrumP915, blackdrumP915forageP120, smallbluecrabP120), names_to= "predictor")
graphs(df_env_bc_forage_long, df_env_bc_forage)

df_env_bc_forage_long %>% ggplot(aes(x= value, y= pred2)) + geom_point() + facet_wrap(~predictor, scales= "free") + geom_smooth(method= "gam", formula= blackdrumP915 ~ avgsdo+avgdepth+avgssal+avgstemp+blackdrumP915forageP120+NoFishRest+smallbluecrabP120)

graphs <- function(df, df2){
  plot1 <- df %>% ggplot(aes(x= value, y= pred2)) + geom_point() + geom_smooth(loess=TRUE) + facet_wrap(~predictor, scales= "free") + standard_theme + ylab("Predicted red drum CPUE") + geom_smooth(method= "gam", formula= reddrumP915 ~ avgsdo)
  # plot2 <-df2 %>% ggplot(aes(x= reddrumP915, y= pred2)) + geom_point() + geom_smooth(loess=TRUE) + standard_theme
  print(plot1)
}
```


#### Year is important:
```{r}
df <- df_CPUE_length_wide_both
sample_size_both = floor(0.8*nrow(df))
picked_both = sample(seq_len(nrow(df)),size = sample_size_both) 
df_test = df[-picked_both,]
df_train = df[picked_both,]

reddrum_env <- gam(reddrumP915~s(avgdepth)+s(avgssal)+s(avgstemp)+s(avgsdo)+s(NoFishRest)+factor(Yearfactor), family= tw(), data=df_train)

df2 <- as.data.frame(predict(reddrum_env), newdata= df_test, type= "response")
colnames(df2) <- "prediction"
df2 <- df2 %>% mutate(pred2= exp(prediction))
r2_general(df2$pred2, df_train$reddrumP915)
```


